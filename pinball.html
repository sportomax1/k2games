<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Pinball Ultra - K2 games</title>
    <style>
        :root {
            --primary: #00f2ff;
            --secondary: #7000ff;
            --accent: #ff007a;
            --bg: #050505;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; touch-action: none; }
        
        body {
            background-color: var(--bg);
            color: white;
            font-family: 'Segoe UI', system-ui, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            align-items: center;
        }

        #ui {
            width: 100%;
            max-width: 500px;
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.05);
            padding: 0.4rem 1rem;
            border-radius: 12px;
            border: 1px solid rgba(0, 242, 255, 0.2);
            text-align: center;
        }

        .stat-label { font-size: 0.6rem; color: var(--primary); text-transform: uppercase; }
        .stat-value { font-size: 1.2rem; font-weight: 900; font-family: monospace; }

        #game-area {
            position: relative;
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            overflow: hidden;
        }

        canvas {
            background: #000;
            border: 4px solid var(--secondary);
            border-radius: 20px;
            box-shadow: 0 0 40px rgba(112, 0, 255, 0.3);
            max-width: 95vw;
            max-height: 65vh;
        }

        .flipper-controls {
            width: 100%;
            max-width: 500px;
            display: flex;
            justify-content: space-between;
            padding: 15px;
            gap: 15px;
        }

        .flipper-btn {
            flex: 1;
            height: 70px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid var(--primary);
            border-radius: 15px;
            color: var(--primary);
            font-weight: 900;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: 0.1s;
        }

        .flipper-btn:active {
            background: var(--primary);
            color: black;
            transform: scale(0.95);
            box-shadow: 0 0 20px var(--primary);
        }

        .plunger-btn {
            background: var(--accent);
            border-color: white;
            color: white;
            box-shadow: 0 0 15px var(--accent);
        }
        .plunger-btn:active { background: #fff; color: var(--accent); }

        .back-link {
            position: absolute; top: 20px; left: 20px;
            color: white; text-decoration: none; font-size: 0.8rem;
            opacity: 0.5;
        }

        #overlay {
            position: absolute; inset: 0;
            background: rgba(0,0,0,0.85);
            display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 100; border-radius: 20px;
        }

        .hint {
            padding: 5px; font-size: 0.7rem; opacity: 0.5; text-align: center; color: white;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">← HUB</a>
    
    <div id="ui">
        <div class="stat-box">
            <div class="stat-label">Score</div>
            <div id="score" class="stat-value">000000</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Balls</div>
            <div id="balls" class="stat-value">3</div>
        </div>
    </div>

    <div id="game-area">
        <canvas id="pinball-canvas"></canvas>
        <div id="overlay">
            <h1 style="color: var(--primary); font-size: 3rem;">GAME OVER</h1>
            <p id="final-score" style="font-size: 1.5rem; margin: 10px 0;">Score: 000000</p>
            <button class="flipper-btn" style="max-width: 200px; height: 60px;" onclick="location.reload()">REPLAY</button>
        </div>
    </div>

    <div class="flipper-controls">
        <div class="flipper-btn" id="left-flipper">LEFT</div>
        <div class="flipper-btn plunger-btn" id="plunger-btn">LAUNCH</div>
        <div class="flipper-btn" id="right-flipper">RIGHT</div>
    </div>

    <div class="hint">
        <b>DESKTOP:</b> [A/D] or [ARROWS] to flip • [S/DOWN] to launch<br>
        <b>MOBILE:</b> Tap on-screen buttons
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.18.0/matter.min.js"></script>
    <script>
        const { Engine, Render, Runner, Bodies, Composite, Events, Body, Vector, Constraint } = Matter;

        const engine = Engine.create();
        const world = engine.world;
        const canvas = document.getElementById('pinball-canvas');
        
        const CW = 450;
        const CH = 750;
        canvas.width = CW;
        canvas.height = CH;

        const render = Render.create({
            canvas: canvas,
            engine: engine,
            options: {
                width: CW, height: CH,
                wireframes: false,
                background: 'transparent'
            }
        });

        // --- Walls & Outer Bounds ---
        const walls = [
            Bodies.rectangle(CW/2, -10, CW, 20, { isStatic: true }),
            Bodies.rectangle(-10, CH/2, 20, CH, { isStatic: true }),
            Bodies.rectangle(CW+10, CH/2, 20, CH, { isStatic: true }),
            // Launch Alley Wall
            Bodies.rectangle(CW - 40, CH/2 + 100, 10, CH - 200, { isStatic: true, render: { fillStyle: '#333' } }),
            // Corner Deflector (Top of launch alley)
            Bodies.rectangle(CW - 20, 40, 80, 10, { isStatic: true, angle: -Math.PI/4, render: { fillStyle: '#333' } }),
            // Bottom Slopes
            Bodies.rectangle(80, CH - 120, 180, 20, { isStatic: true, angle: Math.PI/6, render: { fillStyle: '#333' } }),
            Bodies.rectangle(CW - 120, CH - 120, 180, 20, { isStatic: true, angle: -Math.PI/6, render: { fillStyle: '#333' } })
        ];

        // --- Flippers ---
        const createFlipper = (x, y, side) => {
            const length = 90;
            const pivotX = side === 'left' ? x - length/3 : x + length/3;
            const flipper = Bodies.rectangle(x, y, length, 25, {
                chamfer: { radius: 10 },
                render: { fillStyle: '#00f2ff', strokeStyle: '#fff', lineWidth: 2 },
                collisionFilter: { group: -1 }
            });
            const pivot = Bodies.circle(pivotX, y, 2, { isStatic: true, render: { visible: false } });
            const constraint = Constraint.create({
                bodyA: flipper, pointB: { x: pivotX, y: y },
                stiffness: 1, length: 0, render: { visible: false }
            });
            return { body: flipper, pivot, constraint, side };
        };

        const leftFlipper = createFlipper(120, CH - 60, 'left');
        const rightFlipper = createFlipper(CW - 160, CH - 60, 'right');

        // --- Plunger ---
        const plunger = Bodies.rectangle(CW - 20, CH - 30, 30, 20, { 
            isStatic: true, label: 'plunger', render: { fillStyle: '#ff007a' } 
        });

        // --- Bumpers ---
        const createBumper = (x, y, r, score) => {
            const b = Bodies.circle(x, y, r, { isStatic: true, label: 'bumper', render: { fillStyle: '#ff007a', strokeStyle: '#fff', lineWidth: 4 } });
            b.scoreValue = score; return b;
        };
        const bumpers = [
            createBumper(CW/2 - 20, 180, 35, 1000),
            createBumper(CW/3, 300, 25, 500),
            createBumper(CW*2/3 - 40, 300, 25, 500),
            createBumper(100, 450, 20, 250),
            createBumper(CW-180, 450, 20, 250)
        ];

        // --- Slingshots ---
        const createSlingshot = (x, y, angle) => Bodies.rectangle(x, y, 80, 15, { isStatic: true, angle, label: 'slingshot', render: { fillStyle: '#7000ff', strokeStyle: '#00f2ff', lineWidth: 2 } });
        const slingshots = [createSlingshot(60, 500, Math.PI/4), createSlingshot(CW - 140, 500, -Math.PI/4)];

        // --- Ball ---
        let ballCount = 3;
        let score = 0;
        let ball;

        const spawnBall = () => {
            if (ballCount <= 0) return;
            ball = Bodies.circle(CW - 20, CH - 60, 14, { restitution: 0.5, friction: 0.001, density: 0.05, label: 'ball', render: { fillStyle: '#fff', strokeStyle: '#00f2ff', lineWidth: 2 } });
            Composite.add(world, ball);
        };

        Composite.add(world, [...walls, ...bumpers, ...slingshots, leftFlipper.body, leftFlipper.pivot, leftFlipper.constraint, rightFlipper.body, rightFlipper.pivot, rightFlipper.constraint, plunger]);

        // --- Handling ---
        const flip = (flipper, active) => {
            const targetAngle = flipper.side === 'left' ? (active ? -0.6 : 0.6) : (active ? 0.6 : -0.6);
            Body.setAngularVelocity(flipper.body, (targetAngle - flipper.body.angle) * 0.8);
        };

        const lBtn = document.getElementById('left-flipper');
        const rBtn = document.getElementById('right-flipper');
        const pBtn = document.getElementById('plunger-btn');

        const launchBall = () => {
            if (ball && ball.position.y > CH - 100 && ball.position.x > CW - 40) {
                Body.applyForce(ball, ball.position, { x: 0, y: -1.2 });
                // Visual plunger kick
                Body.setPosition(plunger, { x: CW - 20, y: CH - 50 });
                setTimeout(() => Body.setPosition(plunger, { x: CW - 20, y: CH - 30 }), 100);
            }
        };

        lBtn.addEventListener('mousedown', () => flip(leftFlipper, true));
        lBtn.addEventListener('mouseup', () => flip(leftFlipper, false));
        lBtn.addEventListener('touchstart', (e) => { e.preventDefault(); flip(leftFlipper, true); });
        lBtn.addEventListener('touchend', (e) => { e.preventDefault(); flip(leftFlipper, false); });

        rBtn.addEventListener('mousedown', () => flip(rightFlipper, true));
        rBtn.addEventListener('mouseup', () => flip(rightFlipper, false));
        rBtn.addEventListener('touchstart', (e) => { e.preventDefault(); flip(rightFlipper, true); });
        rBtn.addEventListener('touchend', (e) => { e.preventDefault(); flip(rightFlipper, false); });

        pBtn.addEventListener('mousedown', launchBall);
        pBtn.addEventListener('touchstart', (e) => { e.preventDefault(); launchBall(); });

        window.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft' || e.key === 'a') flip(leftFlipper, true);
            if (e.key === 'ArrowRight' || e.key === 'd') flip(rightFlipper, true);
            if (e.key === 'ArrowDown' || e.key === 's') launchBall();
        });
        window.addEventListener('keyup', (e) => {
            if (e.key === 'ArrowLeft' || e.key === 'a') flip(leftFlipper, false);
            if (e.key === 'ArrowRight' || e.key === 'd') flip(rightFlipper, false);
        });

        Events.on(engine, 'collisionStart', (event) => {
            event.pairs.forEach((pair) => {
                const labels = [pair.bodyA.label, pair.bodyB.label];
                if (labels.includes('bumper')) {
                    const bumper = pair.bodyA.label === 'bumper' ? pair.bodyA : pair.bodyB;
                    const ballObj = pair.bodyA.label === 'ball' ? pair.bodyA : pair.bodyB;
                    score += bumper.scoreValue || 500; updateUI();
                    Body.applyForce(ballObj, ballObj.position, Vector.mult(Vector.normalise(Vector.sub(ballObj.position, bumper.position)), 0.25));
                }
                if (labels.includes('slingshot')) {
                    const ballObj = pair.bodyA.label === 'ball' ? pair.bodyA : pair.bodyB;
                    score += 100; updateUI();
                    Body.applyForce(ballObj, ballObj.position, { x: (ballObj.position.x < CW/2 ? 0.3 : -0.3), y: -0.2 });
                }
            });
        });

        const updateUI = () => { document.getElementById('score').textContent = score.toString().padStart(6, '0'); document.getElementById('balls').textContent = ballCount; };

        Events.on(engine, 'afterUpdate', () => {
            const limit = 0.6;
            if (leftFlipper.body.angle < -limit) Body.setAngle(leftFlipper.body, -limit);
            if (leftFlipper.body.angle > limit) Body.setAngle(leftFlipper.body, limit);
            if (rightFlipper.body.angle > limit) Body.setAngle(rightFlipper.body, limit);
            if (rightFlipper.body.angle < -limit) Body.setAngle(rightFlipper.body, -limit);
            
            if (ball && ball.position.y > CH + 100) {
                ballCount--; updateUI();
                Composite.remove(world, ball);
                if (ballCount > 0) spawnBall();
                else { document.getElementById('final-score').textContent = `Score: ${score.toString().padStart(6, '0')}`; document.getElementById('overlay').style.display = 'flex'; }
            }
        });

        Render.run(render);
        Runner.run(Runner.create(), engine);
        spawnBall();
    </script>
</body>
</html>
