<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Centipede Neon - K2 games</title>
    <style>
        :root {
            --neon-green: #39ff14;
            --neon-pink: #ff00ff;
            --neon-blue: #00f2ff;
            --neon-red: #ff3131;
        }
        body {
            margin: 0;
            background: #050505;
            color: #fff;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: 'Segoe UI', Tahoma, sans-serif;
            touch-action: none;
        }
        canvas {
            border: 2px solid #222;
            box-shadow: 0 0 30px rgba(0,0,0,1);
            max-width: 100%;
            max-height: 100%;
            background: #000;
        }
        #ui {
            position: absolute;
            top: 15px;
            width: 100%;
            display: flex;
            justify-content: space-around;
            pointer-events: none;
            z-index: 10;
            font-weight: 900;
            text-shadow: 0 0 10px #000;
            font-size: 1.2rem;
        }
        .stat span { color: var(--neon-green); }
        #game-over {
            position: absolute;
            text-align: center;
            display: none;
            background: rgba(0,0,0,0.9);
            padding: 40px;
            border: 3px solid var(--neon-pink);
            border-radius: 30px;
            backdrop-filter: blur(10px);
            z-index: 100;
        }
        .btn {
            background: var(--neon-blue);
            color: #000;
            border: none;
            padding: 10px 25px;
            border-radius: 50px;
            font-weight: bold;
            margin-top: 20px;
            cursor: pointer;
        }
        .control-btn {
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            transition: background 0.1s;
            cursor: pointer;
        }
        .control-btn:active { background: rgba(255,255,255,0.3) !important; }
    </style>
</head>
<body onload="checkTouch()">

<div id="ui">
    <div class="stat">SCORE: <span id="score">0</span></div>
    <div class="stat">WAVE: <span id="wave">1</span></div>
    <div class="stat">LIVES: <span id="lives">3</span></div>
</div>

<canvas id="gameCanvas"></canvas>

<div id="game-over">
    <h1 style="color: var(--neon-red); font-size: 3rem; margin-bottom: 10px;">GAME OVER</h1>
    <p style="font-size: 1.5rem;">FINAL SCORE: <span id="final-score" style="color: var(--neon-green)">0</span></p>
    <button class="btn" onclick="resetGame()">RESTART SYSTEM</button>
</div>

<div id="mobile-controls" style="position: absolute; bottom: 30px; left: 0; right: 0; display: none; justify-content: space-between; padding: 0 30px; pointer-events: none; z-index: 60;">
    <div style="display: grid; grid-template-columns: repeat(3, 60px); grid-template-rows: repeat(2, 60px); gap: 5px; pointer-events: auto;">
        <div class="control-btn" style="grid-column: 2; background: rgba(255,255,255,0.1); border: 2px solid var(--neon-blue); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;" ontouchstart="player.dy = -player.speed" ontouchend="player.dy = 0">‚Üë</div>
        <div class="control-btn" style="grid-row: 2; grid-column: 1; background: rgba(255,255,255,0.1); border: 2px solid var(--neon-blue); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;" ontouchstart="player.dx = -player.speed" ontouchend="player.dx = 0">‚Üê</div>
        <div class="control-btn" style="grid-row: 2; grid-column: 2; background: rgba(255,255,255,0.1); border: 2px solid var(--neon-blue); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;" ontouchstart="player.dy = player.speed" ontouchend="player.dy = 0">‚Üì</div>
        <div class="control-btn" style="grid-row: 2; grid-column: 3; background: rgba(255,255,255,0.1); border: 2px solid var(--neon-blue); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;" ontouchstart="player.dx = player.speed" ontouchend="player.dx = 0">‚Üí</div>
    </div>
    <div class="control-btn" style="width: 80px; height: 80px; background: rgba(239, 68, 68, 0.2); border: 3px solid var(--neon-red); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 900; pointer-events: auto;" ontouchstart="shoot()">FIRE</div>
</div>

<script>
    function checkTouch() {
        if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
            document.getElementById('mobile-controls').style.display = 'flex';
        }
    }

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    const GRID = 20;
    let width, height, rows, cols;
    
    let score = 0;
    let wave = 1;
    let lives = 3;
    let gameOver = false;
    let frame = 0;
    let particles = [];
    
    const player = { x: 0, y: 0, w: GRID, h: GRID, speed: 6, dx: 0, dy: 0 };
    let bullets = [];
    let mushrooms = [];
    let centipedes = []; 
    let spider = null;

    function resize() {
        const aspect = 0.75;
        let w = window.innerWidth;
        let h = window.innerHeight;
        if (w / h > aspect) w = h * aspect;
        else h = w / aspect;
        
        canvas.width = Math.floor(w / GRID) * GRID;
        canvas.height = Math.floor(h / GRID) * GRID;
        width = canvas.width;
        height = canvas.height;
        cols = width / GRID;
        rows = height / GRID;
        
        if (mushrooms.length === 0) resetGame();
    }

    function resetGame() {
        score = 0;
        wave = 1;
        lives = 3;
        gameOver = false;
        mushrooms = [];
        centipedes = [];
        bullets = [];
        particles = [];
        spider = null;
        
        document.getElementById('game-over').style.display = 'none';
        player.x = Math.floor(cols / 2) * GRID;
        player.y = (rows - 3) * GRID;

        generateMushrooms();
        spawnCentipede(10);
        updateUI();
    }

    function generateMushrooms() {
        const count = Math.floor(cols * rows * 0.05);
        for (let i = 0; i < count; i++) {
            const r = Math.floor(Math.random() * (rows - 8)) + 2;
            const c = Math.floor(Math.random() * cols);
            // Don't overlap
            if (!mushrooms.some(m => m.x === c * GRID && m.y === r * GRID)) {
                mushrooms.push({ x: c * GRID, y: r * GRID, hp: wave === 1 ? 1 : 4 });
            }
        }
    }

    function spawnCentipede(length) {
        const segments = [];
        for (let i = 0; i < length; i++) {
            segments.push({
                x: Math.floor(cols / 2) * GRID,
                y: -i * GRID,
                vx: GRID,
                vy: 0,
                isHead: i === 0
            });
        }
        centipedes.push(segments);
    }

    function createExplosion(x, y, color, count = 8) {
        for (let i = 0; i < count; i++) {
            particles.push({
                x, y,
                vx: (Math.random() - 0.5) * 6,
                vy: (Math.random() - 0.5) * 6,
                life: 1,
                color
            });
        }
    }

    function update() {
        if (gameOver) return;

        player.x += player.dx;
        player.y += player.dy;
        player.x = Math.max(0, Math.min(width - GRID, player.x));
        player.y = Math.max((rows - 10) * GRID, Math.min(height - GRID, player.y));

        // Bullets logic
        for (let i = bullets.length - 1; i >= 0; i--) {
            let b = bullets[i];
            b.y -= 15;
            let hit = false;

            // Mushroom hit
            for (let j = mushrooms.length - 1; j >= 0; j--) {
                let m = mushrooms[j];
                if (b.x > m.x && b.x < m.x + GRID && b.y > m.y && b.y < m.y + GRID) {
                    m.hp--;
                    score += 1;
                    createExplosion(m.x + GRID/2, m.y + GRID/2, '#fff', 4);
                    if (m.hp <= 0) { mushrooms.splice(j, 1); score += 4; }
                    hit = true; break;
                }
            }

            // Spider hit
            if (!hit && spider) {
                if (b.x > spider.x && b.x < spider.x + GRID*1.5 && b.y > spider.y && b.y < spider.y + GRID*1.5) {
                    score += 600;
                    createExplosion(spider.x + GRID, spider.y + GRID, '#f00', 15);
                    spider = null;
                    hit = true;
                }
            }

            // Centipede hit
            if (!hit) {
                centipedes.forEach((segs, cIdx) => {
                    segs.forEach((s, sIdx) => {
                        if (b.x > s.x && b.x < s.x + GRID && b.y > s.y && b.y < s.y + GRID) {
                            score += s.isHead ? 100 : 10;
                            createExplosion(s.x + GRID/2, s.y + GRID/2, s.isHead ? '#ff0' : '#f0f', 10);
                            mushrooms.push({ x: s.x, y: s.y, hp: wave === 1 ? 1 : 4 });
                            
                            let newTail = segs.splice(sIdx + 1);
                            if (newTail.length > 0) {
                                newTail[0].isHead = true;
                                centipedes.push(newTail);
                            }
                            segs.splice(sIdx, 1);
                            hit = true;
                        }
                    });
                });
            }

            if (b.y < 0 || hit) bullets.splice(i, 1);
        }

        // Centipede Movement (Grid Lock)
        const moveDelay = Math.max(2, 8 - wave); // Start slower (8), get faster
        if (frame % moveDelay === 0) {
            centipedes.forEach((segs) => {
                if (segs.length === 0) return;
                let head = segs[0];
                let oldPositions = segs.map(s => ({x: s.x, y: s.y}));

                let nextX = head.x + head.vx;
                let hitWall = nextX < 0 || nextX >= width;
                let hitMush = mushrooms.some(m => m.x === nextX && m.y === head.y);

                if (hitWall || hitMush) {
                    head.y += GRID;
                    head.vx *= -1;
                    if (head.y >= height) head.y = (rows - 6) * GRID; 
                } else {
                    head.x = nextX;
                }

                for (let i = 1; i < segs.length; i++) {
                    segs[i].x = oldPositions[i-1].x;
                    segs[i].y = oldPositions[i-1].y;
                }

                segs.forEach(s => {
                    if (Math.abs(s.x - player.x) < GRID*0.7 && Math.abs(s.y - player.y) < GRID*0.7) loseLife();
                });
            });
            centipedes = centipedes.filter(c => c.length > 0);
        }

        if (centipedes.length === 0) {
            wave++;
            spawnCentipede(Math.min(15, 8 + wave));
            updateUI();
        }

        // Spider AI
        if (!spider && Math.random() < 0.003 + (wave * 0.001)) {
            spider = { x: Math.random() < 0.5 ? -GRID : width, y: (rows - 5) * GRID, vx: Math.random() < 0.5 ? 3 : -3, vy: 2, timer: 0 };
        }
        if (spider) {
            spider.x += spider.vx;
            spider.y += Math.sin(spider.timer) * 5;
            spider.timer += 0.1;
            if (spider.x < -GRID*2 || spider.x > width + GRID*2) spider = null;
            else if (Math.abs(spider.x - player.x) < GRID*1.2 && Math.abs(spider.y - player.y) < GRID*1.2) loseLife();
        }

        particles.forEach((p, i) => {
            p.x += p.vx; p.y += p.vy; p.life -= 0.02;
            if (p.life <= 0) particles.splice(i, 1);
        });

        frame++;
        updateUI();
    }

    function loseLife() {
        lives--;
        createExplosion(player.x + GRID/2, player.y + GRID/2, '#00f2ff', 20);
        if (lives <= 0) {
            gameOver = true;
            document.getElementById('game-over').style.display = 'block';
            document.getElementById('final-score').innerText = score;
        } else {
            player.x = Math.floor(cols / 2) * GRID;
            player.y = (rows - 3) * GRID;
            spider = null;
            // Clear area around player
            mushrooms = mushrooms.filter(m => Math.hypot(m.x - player.x, m.y - player.y) > GRID * 3);
        }
    }

    function draw() {
        ctx.fillStyle = '#050505';
        ctx.fillRect(0, 0, width, height);

        // Mushrooms
        mushrooms.forEach(m => {
            ctx.fillStyle = m.hp > 1 ? '#fff' : '#aaa';
            ctx.beginPath();
            ctx.arc(m.x + GRID/2, m.y + GRID/2, GRID/2 - 2, 0, Math.PI * 2);
            ctx.fill();
        });

        // Centipedes
        centipedes.forEach(segs => {
            segs.forEach((s, i) => {
                ctx.fillStyle = s.isHead ? '#ff0' : '#f0f';
                ctx.beginPath();
                ctx.arc(s.x + GRID/2, s.y + GRID/2, GRID/2 - 1, 0, Math.PI * 2);
                ctx.fill();
            });
        });

        // Player
        ctx.fillStyle = '#00f2ff';
        ctx.beginPath();
        ctx.moveTo(player.x + GRID/2, player.y);
        ctx.lineTo(player.x, player.y + GRID);
        ctx.lineTo(player.x + GRID, player.y + GRID);
        ctx.fill();

        // Bullets
        ctx.fillStyle = '#fff';
        bullets.forEach(b => ctx.fillRect(b.x - 1, b.y, 3, 10));

        // Spider
        if (spider) {
            ctx.fillStyle = '#f00';
            ctx.font = '24px Arial';
            ctx.fillText('üï∑Ô∏è', spider.x, spider.y + GRID);
        }

        // Particles
        particles.forEach(p => {
            ctx.globalAlpha = p.life;
            ctx.fillStyle = p.color;
            ctx.fillRect(p.x, p.y, 3, 3);
        });
        ctx.globalAlpha = 1;

        requestAnimationFrame(() => { update(); draw(); });
    }

    function updateUI() {
        document.getElementById('score').innerText = score;
        document.getElementById('wave').innerText = wave;
        document.getElementById('lives').innerText = lives;
    }

    // Input
    window.addEventListener('keydown', e => {
        if (e.key === 'ArrowLeft' || e.key === 'a') player.dx = -player.speed;
        if (e.key === 'ArrowRight' || e.key === 'd') player.dx = player.speed;
        if (e.key === 'ArrowUp' || e.key === 'w') player.dy = -player.speed;
        if (e.key === 'ArrowDown' || e.key === 's') player.dy = player.speed;
        if (e.key === ' ' || e.key === 'Enter') shoot();
    });
    window.addEventListener('keyup', e => {
        if (['ArrowLeft', 'ArrowRight', 'a', 'd'].includes(e.key)) player.dx = 0;
        if (['ArrowUp', 'ArrowDown', 'w', 's'].includes(e.key)) player.dy = 0;
    });

    function shoot() {
        if (bullets.length < 4 && !gameOver) {
            bullets.push({ x: player.x + GRID/2, y: player.y });
        }
    }

    // Better Touch Controls
    canvas.addEventListener('touchstart', e => {
        if (e.target === canvas) {
            e.preventDefault();
            shoot();
        }
    }, {passive: false});

    canvas.addEventListener('touchmove', e => {
        if (e.target === canvas) {
            e.preventDefault();
            const t = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            player.x = (t.clientX - rect.left) * scaleX - GRID/2;
            player.y = (t.clientY - rect.top) * scaleY - GRID/2;
        }
    }, {passive: false});

    window.addEventListener('resize', resize);
    resize();
    draw();

</script>
</body>
</html>