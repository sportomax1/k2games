<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Titled Duck Game: Definitive Edition - K2 games</title>
    <style>
        :root {
            --bg: #f8fafc;
            --panel: #ffffff;
            --accent: #0ea5e9;
            --duck-body: #fffde7;
            --duck-beak: #fbbf24;
            --text: #1e293b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; touch-action: none; }
        
        body {
            background-color: #0f172a;
            color: var(--text);
            font-family: 'Segoe UI', system-ui, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: row;
            overflow: hidden;
        }

        @media (max-width: 900px) {
            body { flex-direction: column; }
            #sidebar { width: 100% !important; height: 35% !important; border-right: none !important; border-bottom: 2px solid #e2e8f0; }
            #main-view { flex: 1; padding: 0 !important; }
            canvas { width: 100% !important; height: 100% !important; border-radius: 0 !important; }
        }

        #sidebar {
            width: 340px; background: #fff; padding: 1.2rem; display: flex; flex-direction: column; gap: 0.8rem;
            box-shadow: 10px 0 30px rgba(0,0,0,0.2); z-index: 10; border-right: 2px solid #e2e8f0;
            background-image: linear-gradient(#f1f5f9 1px, transparent 1px), linear-gradient(90deg, #f1f5f9 1px, transparent 1px);
            background-size: 20px 20px; overflow-y: auto;
        }

        .logo { font-size: 1.6rem; font-weight: 900; color: #0c4a6e; letter-spacing: -1px; font-style: italic; border-bottom: 4px solid var(--duck-beak); padding-bottom: 0.3rem; }
        .section-title { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.2em; color: #64748b; font-weight: 800; margin-top: 0.3rem; }

        .todo-container { background: #fffdfa; border: 1px solid #e2e8f0; padding: 0.8rem; border-radius: 4px; box-shadow: 2px 2px 10px rgba(0,0,0,0.05); }
        .todo-list { list-style: none; display: flex; flex-direction: column; gap: 6px; }
        .todo-item { font-size: 0.8rem; font-family: 'Comic Sans MS', cursive, sans-serif; color: #475569; display: flex; align-items: flex-start; gap: 8px; }
        .todo-item.done { color: #94a3b8; text-decoration: line-through; }
        .check-box { width: 14px; height: 14px; border: 2px solid #94a3b8; flex-shrink: 0; margin-top: 2px; position: relative; }
        .todo-item.done .check-box::after { content: '‚úì'; position: absolute; top: -8px; left: 0px; color: #ef4444; font-size: 1.1rem; font-weight: 900; }

        #main-view { flex: 1; position: relative; align-items: center; justify-content: center; background: #000; overflow: hidden; }
        canvas { background: #fff; display: block; max-width: 100%; max-height: 100%; cursor: crosshair; }

        .timer-pill { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.9); padding: 4px 12px; border-radius: 50px; font-weight: 800; font-family: monospace; font-size: 0.9rem; z-index: 40; border: 1px solid #fff; }

        #mobile-controls { position: absolute; bottom: 20px; left: 0; right: 0; padding: 0 20px; display: none; justify-content: space-between; align-items: flex-end; z-index: 100; pointer-events: none; }
        @media (max-width: 900px) { #mobile-controls { display: flex; } }
        .joystick-base { width: 100px; height: 100px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; pointer-events: auto; }
        .joystick-thumb { width: 40px; height: 40px; background: #fff; border-radius: 50%; }
        .action-btns { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; pointer-events: auto; }
        .action-btn { width: 48px; height: 48px; border-radius: 50%; background: #fff; border: 2px solid #0c4a6e; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: 900; }
        .action-btn:active { background: #0c4a6e; color: #fff; }

        .modal { position: absolute; inset: 0; background: rgba(15, 23, 42, 0.98); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; padding: 1.5rem; overflow-y: auto; }
        .map-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px; width: 100%; max-width: 900px; margin-top: 1.5rem; }
        .map-card { background: white; color: var(--text); padding: 0.8rem; border-radius: 12px; cursor: pointer; transition: 0.2s; text-align: center; border: 4px solid transparent; }
        .map-card:hover { transform: scale(1.05); border-color: var(--accent); }
        .map-card .preview { width: 100%; height: 60px; background: #f1f5f9; border-radius: 8px; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; font-size: 2rem; }
        .map-card h3 { font-size: 0.9rem; margin-bottom: 3px; }
        .map-card p { font-size: 0.65rem; opacity: 0.7; }

        #ui-toast { position: absolute; top: 40px; background: #0c4a6e; color: white; padding: 10px 30px; border-radius: 50px; font-weight: 900; transform: translateY(-150px); transition: 0.4s; z-index: 50; }
        #ui-toast.show { transform: translateY(0); }
    </style>
</head>
<body>
    <aside id="sidebar">
        <div class="logo">TITLED DUCK</div>
        <div id="map-info" style="font-size: 0.7rem; font-weight: bold; color: var(--accent);">SELECT A MAP</div>
        
        <div class="todo-container">
            <div class="section-title" style="margin-top:0; margin-bottom:0.4rem;">To-Do List</div>
            <ul class="todo-list" id="todo-list"></ul>
        </div>

        <div style="margin-top: auto;">
            <div class="section-title">Controls</div>
            <div style="font-size: 0.65rem; opacity: 0.6;">WASD/ARROWS: Move ‚Ä¢ G: Grab ‚Ä¢ Space: Honk ‚Ä¢ F: Flap ‚Ä¢ E: Use ‚Ä¢ C: Sneak</div>
        </div>
    </aside>

    <main id="main-view">
        <div id="ui-toast">HONK!!!</div>
        <div class="timer-pill" id="timer">00:00</div>
        <canvas id="gameCanvas"></canvas>

        <div id="mobile-controls">
            <div class="joystick-base" id="joy-base"><div class="joystick-thumb" id="joy-thumb"></div></div>
            <div class="action-btns">
                <div class="action-btn" id="btn-honk" title="Honk">üì¢</div>
                <div class="action-btn" id="btn-grab" title="Grab">‚úä</div>
                <div class="action-btn" id="btn-flap" title="Flap">ü™Ω</div>
                <div class="action-btn" id="btn-use" title="Use">‚öôÔ∏è</div>
                <div class="action-btn" id="btn-sneak" title="Sneak">üïµÔ∏è</div>
                <div class="action-btn" id="btn-gift" title="Poop">üí©</div>
            </div>
        </div>

        <div id="selection-modal" class="modal">
            <h1 style="font-size: 2.5rem; font-style: italic; color: var(--duck-beak);">Where to today?</h1>
            <div class="map-grid">
                <div class="map-card" onclick="game.loadMap('garden')"><div class="preview">üë®‚Äçüåæ</div><h3>Garden</h3><p>Ruin the lawn.</p></div>
                <div class="map-card" onclick="game.loadMap('house')"><div class="preview">üè†</div><h3>House</h3><p>Indoor mischief.</p></div>
                <div class="map-card" onclick="game.loadMap('store')"><div class="preview">üõí</div><h3>Store</h3><p>Cleanup needed.</p></div>
                <div class="map-card" onclick="game.loadMap('park')"><div class="preview">‚õ≤</div><h3>Park</h3><p>Picnic panic.</p></div>
                <div class="map-card" onclick="game.loadMap('office')"><div class="preview">üíº</div><h3>Office</h3><p>Fire the boss.</p></div>
            </div>
        </div>

        <div id="victory-screen" class="modal" style="display:none;">
            <h1 style="font-size: 4rem; color: #ef4444;">GOOSE!</h1>
            <p>You ruined everything. Mission accomplished.</p>
            <button class="action-btn" onclick="location.reload()" style="width:auto; padding: 0 30px; border-radius:50px; margin-top:20px;">NEXT LEVEL</button>
        </div>
    </main>

    <script>
        const MAPS = {
            garden: {
                name: 'The Garden', bg: '#ecfdf5', ground: '#dcfce7',
                npcs: [{ x: 800, y: 200, emoji: 'üë®‚Äçüåæ', name: 'Gardener' }],
                items: [
                    { id: 'rake', x: 400, y: 150, emoji: 'üßπ' },
                    { id: 'sandwich', x: 700, y: 220, emoji: 'ü•™' },
                    { id: 'radio', x: 150, y: 150, emoji: 'üìª', usable: true },
                    { id: 'rose', x: 850, y: 150, emoji: 'üåπ' }
                ],
                scenery: [
                    { x: 600, y: 400, r: 130, type: 'lake', color: '#7dd3fc' },
                    { x: 100, y: 500, w: 120, h: 80, type: 'rug', color: '#fca5a5' }
                ],
                missions: [
                    { id: 'rake_lake', text: 'Put rake in the lake' },
                    { id: 'radio_on', text: 'Turn on the radio' },
                    { id: 'steal_sandwich', text: 'Steal the sandwich' },
                    { id: 'scare_gardener', text: 'Scare the gardener' },
                    { id: 'rose_rug', text: 'Bring rose to rug' }
                ]
            },
            house: {
                name: 'The House', bg: '#fef2f2', ground: '#fecaca',
                npcs: [{ x: 500, y: 500, emoji: 'üë©', name: 'Owner' }],
                items: [
                    { id: 'toast', x: 200, y: 200, emoji: 'üçû' },
                    { id: 'vase', x: 800, y: 150, emoji: 'üè∫', breakable: true },
                    { id: 'slippers', x: 100, y: 600, emoji: 'üëü' },
                    { id: 'remote', x: 450, y: 450, emoji: 'üéÆ' }
                ],
                scenery: [
                    { x: 400, y: 100, w: 200, h: 60, type: 'counter', color: '#94a3b8' },
                    { x: 700, y: 600, r: 50, type: 'sink', color: '#38bdf8' }
                ],
                missions: [
                    { id: 'break_vase', text: 'Break the fancy vase' },
                    { id: 'steal_toast', text: 'Steal the breakfast' },
                    { id: 'hide_slippers', text: 'Hide the slippers' },
                    { id: 'honk_owner', text: 'Honk at the lady' },
                    { id: 'drown_remote', text: 'Drown the remote' }
                ]
            },
            store: {
                name: 'The Store', bg: '#eff6ff', ground: '#dbeafe',
                npcs: [{ x: 100, y: 100, emoji: 'üë∑', name: 'Clerk' }],
                items: [
                    { id: 'apple', x: 300, y: 300, emoji: 'üçé' },
                    { id: 'toy', x: 700, y: 500, emoji: 'üß∏' },
                    { id: 'milk', x: 500, y: 100, emoji: 'ü•õ' },
                    { id: 'glasses', x: 150, y: 120, emoji: 'üëì' }
                ],
                scenery: [{ x: 200, y: 400, w: 600, h: 40, type: 'shelf', color: '#cbd5e1' }],
                missions: [
                    { id: 'steal_toy', text: 'Steal a shiny toy' },
                    { id: 'mess_aisle', text: 'Make a mess' },
                    { id: 'apple_cart', text: 'Apple to the door' },
                    { id: 'clerk_trap', text: 'Trap the clerk' },
                    { id: 'steal_glasses', text: 'Steal the glasses' }
                ]
            },
            park: {
                name: 'The Park', bg: '#f0fdf4', ground: '#dcfce7',
                npcs: [{ x: 200, y: 200, emoji: 'üë¶', name: 'Kid' }],
                items: [
                    { id: 'basket', x: 500, y: 400, emoji: 'üß∫' },
                    { id: 'ball', x: 800, y: 600, emoji: '‚öΩ' },
                    { id: 'hat', x: 100, y: 100, emoji: 'üß¢' }
                ],
                scenery: [
                    { x: 700, y: 200, r: 80, type: 'fountain', color: '#38bdf8' },
                    { x: 100, y: 600, w: 100, h: 80, type: 'goal', color: '#fff' }
                ],
                missions: [
                    { id: 'steal_basket', text: 'Steal the picnic' },
                    { id: 'fountain_swim', text: 'Swim in fountain' },
                    { id: 'scare_kid', text: 'Honk at the kid' },
                    { id: 'score_goal', text: 'Score a goal' },
                    { id: 'steal_hat', text: 'Steal the hat' }
                ]
            },
            office: {
                name: 'The Office', bg: '#f8fafc', ground: '#e2e8f0',
                npcs: [{ x: 800, y: 100, emoji: 'üë®‚Äçüíº', name: 'Boss' }],
                items: [
                    { id: 'mug', x: 300, y: 200, emoji: '‚òï' },
                    { id: 'keyboard', x: 600, y: 200, emoji: '‚å®Ô∏è', usable: true },
                    { id: 'paper', x: 450, y: 400, emoji: 'üìÑ' }
                ],
                scenery: [
                    { x: 200, y: 300, w: 150, h: 100, type: 'desk', color: '#64748b' },
                    { x: 800, y: 600, w: 60, h: 80, type: 'shredder', color: '#334155' }
                ],
                missions: [
                    { id: 'steal_mug', text: 'Steal the mug' },
                    { id: 'type_msg', text: 'Type on keyboard' },
                    { id: 'honk_meeting', text: 'Honk at boss' },
                    { id: 'shred_paper', text: 'Shred the paper' },
                    { id: 'lock_boss', text: 'Lock the door' }
                ]
            }
        };

        class DuckGame {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.width = 1000; this.height = 750;
                this.canvas.width = this.width; this.canvas.height = this.height;

                this.player = { x: 150, y: 150, vx: 0, vy: 0, r: 25, speed: 4, honking: false, held: null, dir: 1, anim: 0, flapping: 0, sneaking: false };
                this.keys = {}; this.joy = { active: false, x: 0, y: 0 };
                
                this.currentMap = null;
                this.npcs = []; this.items = []; this.scenery = []; this.todo = []; this.poops = []; this.ripples = [];
                this.startTime = Date.now();

                this.init();
            }

            init() {
                this.setupInputs();
                this.loop();
            }

            loadMap(key) {
                const d = MAPS[key];
                this.currentMap = key;
                document.getElementById('map-info').textContent = d.name;
                document.getElementById('selection-modal').style.display = 'none';
                this.npcs = JSON.parse(JSON.stringify(d.npcs)).map(n => ({...n, tx: n.x, ty: n.y, speed: 1.2, state: 'idle'}));
                this.items = JSON.parse(JSON.stringify(d.items)).map(i => ({...i, w: 40, h: 40, active: false}));
                this.scenery = JSON.parse(JSON.stringify(d.scenery));
                this.todo = d.missions.map(m => ({ ...m, done: false }));
                this.player.x = 150; this.player.y = 150; this.player.held = null;
                this.poops = []; this.renderTodo();
            }

            setupInputs() {
                window.onkeydown = (e) => {
                    this.keys[e.code] = true;
                    if(e.code === 'Space') this.honk();
                    if(e.code === 'KeyG') this.toggleGrab();
                    if(e.code === 'KeyP') this.poop();
                    if(e.code === 'KeyF') this.flap();
                    if(e.code === 'KeyE') this.use();
                    if(e.code === 'KeyC') this.player.sneaking = !this.player.sneaking;
                };
                window.onkeyup = (e) => this.keys[e.code] = false;

                const base = document.getElementById('joy-base'), thumb = document.getElementById('joy-thumb');
                const handleJoy = (e) => {
                    if(!this.joy.active) return;
                    const rect = base.getBoundingClientRect(), t = e.touches ? e.touches[0] : e;
                    const dx = t.clientX - (rect.left + rect.width/2), dy = t.clientY - (rect.top + rect.height/2);
                    const dist = Math.min(40, Math.hypot(dx, dy)), ang = Math.atan2(dy, dx);
                    this.joy.x = Math.cos(ang) * (dist/40); this.joy.y = Math.sin(ang) * (dist/40);
                    thumb.style.transform = `translate(${this.joy.x*40}px, ${this.joy.y*40}px)`;
                };
                base.addEventListener('touchstart', (e) => { this.joy.active = true; handleJoy(e); });
                window.addEventListener('touchmove', handleJoy);
                window.addEventListener('touchend', () => { this.joy.active = false; this.joy.x = 0; this.joy.y = 0; thumb.style.transform = `translate(0,0)`; });

                document.getElementById('btn-honk').addEventListener('touchstart', (e) => { e.preventDefault(); this.honk(); });
                document.getElementById('btn-grab').addEventListener('touchstart', (e) => { e.preventDefault(); this.toggleGrab(); });
                document.getElementById('btn-flap').addEventListener('touchstart', (e) => { e.preventDefault(); this.flap(); });
                document.getElementById('btn-use').addEventListener('touchstart', (e) => { e.preventDefault(); this.use(); });
                document.getElementById('btn-sneak').addEventListener('touchstart', (e) => { e.preventDefault(); this.player.sneaking = !this.player.sneaking; });
                document.getElementById('btn-gift').addEventListener('touchstart', (e) => { e.preventDefault(); this.poop(); });
            }

            flap() { if(this.player.flapping) return; this.player.flapping = 25; this.showToast('ü™Ω FLAP!'); }
            use() {
                const i = this.items.find(it => this.dist(this.player, it) < 60);
                if(i && i.usable) { i.active = !i.active; this.showToast(i.active ? 'ON!' : 'OFF!'); if(i.id === 'radio') this.complete('radio_on'); if(i.id === 'keyboard') this.complete('type_msg'); }
            }
            honk() {
                if(this.player.honking) return; this.player.honking = true; this.showToast('HONK!!!');
                
                // Audio restored
                const audio = new Audio('https://freeanimalsounds.org/wp-content/uploads/2017/07/Ente_quackt.mp3');
                audio.volume = 0.4;
                audio.play().catch(() => {});

                this.npcs.forEach(n => { if(this.dist(this.player, n) < 150) { n.state = 'startled'; n.timer = 60; if(this.currentMap==='garden' && n.name==='Gardener') this.complete('scare_gardener'); if(this.currentMap==='house') this.complete('honk_owner'); if(this.currentMap==='park') this.complete('scare_kid'); if(this.currentMap==='office') this.complete('honk_meeting'); } });
                setTimeout(() => this.player.honking = false, 400);
            }
            toggleGrab() {
                if(this.player.held) { this.checkDrop(this.player.held); this.player.held.held = false; this.player.held = null; }
                else { const i = this.items.find(it => this.dist(this.player, it) < 60); if(i) { i.held = true; this.player.held = i; } }
            }

            checkDrop(i) {
                if(this.currentMap === 'garden') {
                    const l = this.scenery.find(s => s.type === 'lake'); if(i.id === 'rake' && this.dist(i, l) < l.r) this.complete('rake_lake');
                    if(i.id === 'sandwich' && i.x > 600) this.complete('steal_sandwich');
                    const r = this.scenery.find(s => s.type === 'rug'); if(i.id === 'rose' && i.x > r.x && i.x < r.x+r.w && i.y > r.y && i.y < r.y+r.h) this.complete('rose_rug');
                }
                if(this.currentMap === 'house') {
                    if(i.id === 'vase' && i.y > 400) { i.emoji = 'üí•'; this.complete('break_vase'); }
                    if(i.id === 'toast' && i.x > 600) this.complete('steal_toast');
                    if(i.id === 'slippers' && i.y < 200) this.complete('hide_slippers');
                    const s = this.scenery.find(sc => sc.type === 'sink'); if(i.id === 'remote' && this.dist(i, s) < s.r) this.complete('drown_remote');
                }
                if(this.currentMap === 'store') {
                    if(i.id === 'toy' && i.x < 200) this.complete('steal_toy');
                    if(i.id === 'apple' && i.x < 200) this.complete('apple_cart');
                    if(i.id === 'glasses' && i.y > 600) this.complete('steal_glasses');
                }
                if(this.currentMap === 'park') {
                    if(i.id === 'basket' && i.x < 200) this.complete('steal_basket');
                    const f = this.scenery.find(s => s.type === 'fountain'); if(this.dist(this.player, f) < f.r) this.complete('fountain_swim');
                    const g = this.scenery.find(s => s.type === 'goal'); if(i.id === 'ball' && i.x > g.x && i.x < g.x+g.w && i.y > g.y && i.y < g.y+g.h) this.complete('score_goal');
                    if(i.id === 'hat' && i.y > 600) this.complete('steal_hat');
                }
                if(this.currentMap === 'office') {
                    if(i.id === 'mug' && i.x < 200) this.complete('steal_mug');
                    const shr = this.scenery.find(s => s.type === 'shredder'); if(i.id === 'paper' && i.x > shr.x && i.x < shr.x+shr.w && i.y > shr.y && i.y < shr.y+shr.h) { i.emoji = 'üìë'; this.complete('shred_paper'); }
                }
            }

            poop() { this.poops.push({ x: this.player.x, y: this.player.y, life: 1000 }); this.showToast('üí© Splut!'); }
            complete(id) { const t = this.todo.find(m => m.id === id); if(t && !t.done) { t.done = true; this.renderTodo(); this.showToast('To-Do Updated!'); if(this.todo.every(m => m.done)) setTimeout(() => document.getElementById('victory-screen').style.display = 'flex', 1500); } }
            showToast(txt) { const t = document.getElementById('ui-toast'); t.textContent = txt; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 1200); }
            renderTodo() { document.getElementById('todo-list').innerHTML = this.todo.map(t => `<li class="todo-item ${t.done ? 'done' : ''}"><div class="check-box"></div><span>${t.text}</span></li>`).join(''); }

            update() {
                if(!this.currentMap) return;
                let dx = 0, dy = 0;
                if(this.keys['KeyW'] || this.keys['ArrowUp']) dy = -1; 
                if(this.keys['KeyS'] || this.keys['ArrowDown']) dy = 1; 
                if(this.keys['KeyA'] || this.keys['ArrowLeft']) dx = -1; 
                if(this.keys['KeyD'] || this.keys['ArrowRight']) dx = 1;
                
                if(this.joy.active) { dx = this.joy.x; dy = this.joy.y; }
                
                const speed = this.player.sneaking ? 1.5 : (this.player.flapping > 0 ? 7 : 4);
                if(this.player.flapping > 0) this.player.flapping--;
                
                this.player.x += dx * speed; this.player.y += dy * speed;
                if(dx !== 0 || dy !== 0) { this.player.anim += 0.15; if(dx !== 0) this.player.dir = dx > 0 ? 1 : -1; }
                this.player.x = Math.max(30, Math.min(this.width-30, this.player.x));
                this.player.y = Math.max(30, Math.min(this.height-30, this.player.y));
                if(this.player.held) { this.player.held.x = this.player.x + (25*this.player.dir); this.player.held.y = this.player.y - 10; }

                this.npcs.forEach(n => {
                    if(n.state === 'startled') { n.x += Math.sin(Date.now()/50)*5; n.timer--; if(n.timer<=0) n.state = 'idle'; }
                    else {
                        if(this.dist(n, {x: n.tx, y: n.ty}) < 10) { n.tx = 100+Math.random()*800; n.ty = 100+Math.random()*600; }
                        const ang = Math.atan2(n.ty-n.y, n.tx-n.x);
                        n.x += Math.cos(ang)*n.speed; n.y += Math.sin(ang)*n.speed;
                    }
                });
                const sec = Math.floor((Date.now()-this.startTime)/1000);
                document.getElementById('timer').textContent = `${Math.floor(sec/60).toString().padStart(2,'0')}:${(sec%60).toString().padStart(2,'0')}`;
            }

            draw() {
                if(!this.currentMap) return;
                const ctx = this.ctx; ctx.clearRect(0,0,this.width,this.height);
                ctx.fillStyle = MAPS[this.currentMap].bg; ctx.fillRect(0,0,this.width,this.height);
                this.scenery.forEach(s => { ctx.fillStyle = s.color; if(s.r) { ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI*2); ctx.fill(); } else ctx.fillRect(s.x, s.y, s.w, s.h); });
                this.poops.forEach(p => { ctx.fillStyle = '#713f12'; ctx.beginPath(); ctx.arc(p.x, p.y+20, 6, 0, Math.PI*2); ctx.fill(); });
                this.items.forEach(i => { if(!i.held) { ctx.font = '40px Arial'; ctx.fillText(i.emoji, i.x-20, i.y+20); if(i.active) { ctx.font='15px Arial'; ctx.fillText('üéµ', i.x, i.y-25); } } });
                this.npcs.forEach(n => { ctx.font = '50px Arial'; ctx.fillText(n.emoji, n.x - 25, n.y + 25); });

                ctx.save(); ctx.translate(this.player.x, this.player.y); if(this.player.dir === -1) ctx.scale(-1, 1);
                const waddle = Math.sin(this.player.anim)*5;
                ctx.fillStyle = 'rgba(0,0,0,0.1)'; ctx.beginPath(); ctx.ellipse(0, 25, 25, 10, 0, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = this.player.sneaking ? '#cbd5e1' : '#fff';
                ctx.beginPath(); ctx.ellipse(0, waddle, 30, this.player.sneaking ? 12 : 20, 0, 0, Math.PI*2); ctx.fill();
                if(this.player.flapping > 0) { const flap = Math.sin(Date.now()/50)*20; ctx.beginPath(); ctx.ellipse(-5, waddle-10, 15, 10, flap*0.1, 0, Math.PI*2); ctx.fill(); }
                ctx.beginPath(); ctx.arc(25, (this.player.sneaking ? 0 : -15) + waddle, 14, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#fbbf24'; ctx.beginPath(); ctx.ellipse(38, (this.player.sneaking ? 0 : -15) + waddle, 10, 5, 0, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(28, (this.player.sneaking ? -3 : -18) + waddle, 2.5, 0, Math.PI*2); ctx.fill();
                if(this.player.honking) { ctx.strokeStyle = '#fbbf24'; ctx.lineWidth = 4; ctx.beginPath(); ctx.arc(45, -15+waddle, 20, -0.5, 0.5); ctx.stroke(); }
                ctx.restore();
                if(this.player.held) { ctx.font='40px Arial'; ctx.fillText(this.player.held.emoji, this.player.held.x-20, this.player.held.y+20); }
            }

            dist(a, b) { return Math.hypot(a.x - b.x, a.y - b.y); }
            loop() { this.update(); this.draw(); requestAnimationFrame(() => this.loop()); }
        }
        const game = new DuckGame();
    </script>
</body>
</html>
