<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bird Sling: Evolution - K2 games</title>
    <style>
        :root {
            --sky-top: #4facfe;
            --sky-bottom: #00f2fe;
            --grass: #2ecc71;
            --wood: #8B4513;
            --pig: #44ff44;
            --ui-bg: rgba(0, 0, 0, 0.6);
            --accent: #fbbf24;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: #0f172a;
            color: white;
            font-family: 'Segoe UI', system-ui, sans-serif;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            touch-action: none;
        }

        #game-container {
            position: relative;
            width: 100%;
            max-width: 1000px;
            aspect-ratio: 16/9;
            background: linear-gradient(to bottom, var(--sky-top), var(--sky-bottom));
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            border-radius: 20px;
            border: 4px solid #334155;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            pointer-events: none;
            z-index: 10;
        }

        .stat-card {
            background: var(--ui-bg);
            backdrop-filter: blur(12px);
            padding: 12px 24px;
            border-radius: 15px;
            border: 1px solid rgba(255,255,255,0.1);
            font-weight: 900;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-label { font-size: 0.6rem; text-transform: uppercase; opacity: 0.7; letter-spacing: 1px; }
        .stat-val { font-size: 1.4rem; color: var(--accent); font-family: monospace; }

        #power-hint {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--ui-bg);
            padding: 10px 30px;
            border-radius: 50px;
            font-weight: 800;
            font-size: 1.1rem;
            color: white;
            border: 2px solid var(--accent);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 50;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }

        .back-link {
            position: fixed; top: 20px; left: 20px; color: white; text-decoration: none;
            background: rgba(255,255,255,0.1); padding: 10px 20px; border-radius: 12px; z-index: 100;
            font-weight: bold; backdrop-filter: blur(10px); transition: 0.2s;
        }

        #overlay {
            position: absolute; inset: 0;
            background: rgba(15, 23, 42, 0.9);
            display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 1000; backdrop-filter: blur(8px); text-align: center;
        }

        #overlay h1 { font-size: 4rem; margin-bottom: 10px; color: var(--accent); font-weight: 900; }
        
        .btn-large {
            background: var(--accent); color: #000; border: none; padding: 1.2rem 3rem;
            border-radius: 50px; font-weight: 900; cursor: pointer; margin-top: 2rem;
            font-size: 1.5rem; transition: transform 0.2s;
        }
        .btn-large:active { transform: scale(0.95); }

        #level-indicator {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            font-size: 0.8rem; font-weight: 800; opacity: 0.5; text-transform: uppercase;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê HUB</a>

    <div id="game-container">
        <div id="ui">
            <div class="stat-card">
                <span class="stat-label">Score</span>
                <span id="score-val" class="stat-val">0</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">Next Bird</span>
                <span id="bird-type" class="stat-val">üî¥ RED</span>
            </div>
            <div class="stat-card">
                <span class="stat-label">Targets</span>
                <span id="pigs-val" class="stat-val">0</span>
            </div>
        </div>

        <div id="power-hint">TAP SCREEN FOR TURBO!</div>
        <div id="level-indicator">LEVEL 1 / 5</div>

        <canvas id="gameCanvas"></canvas>

        <div id="overlay">
            <h1 id="overlay-title">VICTORY</h1>
            <p id="overlay-msg" style="font-size: 1.5rem;">The structures have fallen.</p>
            <button class="btn-large" id="action-btn" onclick="game.handleAction()">NEXT LEVEL</button>
        </div>
    </div>

    <script>
        const BIRD_TYPES = [
            { id: 'red', name: 'RED', emoji: 'üî¥', color: '#ff4757', power: 'NONE', powerText: '' },
            { id: 'yellow', name: 'YELLOW', emoji: 'üü°', color: '#eccc68', power: 'DASH', powerText: 'TAP FOR SPEED BOOST!' },
            { id: 'blue', name: 'BLUE', emoji: 'üîµ', color: '#70a1ff', power: 'TRIPLE', powerText: 'TAP TO SPLIT INTO THREE!' }
        ];

        class BirdSling {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.width = 1000;
                this.height = 600;
                this.canvas.width = this.width;
                this.canvas.height = this.height;

                this.level = 1;
                this.score = 0;
                this.isGameOver = false;
                
                this.bird = { x: 200, y: 450, r: 22, vx: 0, vy: 0, active: false, dragging: false, anchorX: 200, anchorY: 450, powerUsed: false, trail: [], typeIndex: 0 };
                this.objects = [];
                this.particles = [];
                this.clouds = [];
                this.levelPigs = 0;

                this.init();
            }

            init() {
                for(let i=0; i<10; i++) this.clouds.push({ x: Math.random()*this.width, y: Math.random()*200, w: 100+Math.random()*150, s: 0.2+Math.random()*0.5 });
                this.setupInputs();
                this.loadLevel(1);
                this.loop();
            }

            loadLevel(num) {
                this.level = num;
                this.objects = [];
                this.bird.typeIndex = 0;
                this.resetBird();
                this.isGameOver = false;
                document.getElementById('overlay').style.display = 'none';
                document.getElementById('level-indicator').textContent = `LEVEL ${this.level} / 5`;

                const layout = [
                    [], // 0
                    [{x: 700, y: 540, w: 40, h: 120}, {x: 850, y: 540, w: 40, h: 120}, {x: 700, y: 420, w: 190, h: 20}, {x: 775, y: 380, p: true}],
                    [{x: 650, y: 540, w: 30, h: 100}, {x: 750, y: 540, w: 30, h: 100}, {x: 850, y: 540, w: 30, h: 100}, {x: 650, y: 440, w: 230, h: 20}, {x: 700, y: 400, p: true}, {x: 800, y: 400, p: true}],
                    [{x: 700, y: 540, w: 40, h: 150}, {x: 850, y: 540, w: 40, h: 150}, {x: 700, y: 390, w: 190, h: 20}, {x: 720, y: 340, w: 30, h: 100}, {x: 830, y: 340, w: 30, h: 100}, {x: 775, y: 240, p: true}, {x: 775, y: 500, p: true}],
                    [{x: 600, y: 540, w: 20, h: 180}, {x: 700, y: 540, w: 20, h: 180}, {x: 800, y: 540, w: 20, h: 180}, {x: 900, y: 540, w: 20, h: 180}, {x: 600, y: 360, w: 320, h: 20}, {x: 650, y: 320, p: true}, {x: 750, y: 320, p: true}, {x: 850, y: 320, p: true}],
                    [{x: 750, y: 540, w: 100, h: 100}, {x: 750, y: 440, w: 100, h: 100}, {x: 750, y: 340, w: 100, h: 100}, {x: 700, y: 540, w: 20, h: 300}, {x: 900, y: 540, w: 20, h: 300}, {x: 800, y: 240, p: true}, {x: 800, y: 400, p: true}, {x: 800, y: 500, p: true}]
                ][this.level];

                layout.forEach(o => {
                    if (o.p) this.objects.push({ type: 'enemy', x: o.x, y: o.y, r: 20, hp: 10 });
                    else this.objects.push({ type: 'block', x: o.x, y: o.y - o.h, w: o.w, h: o.h, hp: 100 });
                });

                this.updateUI();
            }

            setupInputs() {
                const getPos = (e) => {
                    const rect = this.canvas.getBoundingClientRect();
                    const t = e.touches ? e.touches[0] : e;
                    return { x: (t.clientX - rect.left) * (this.width / rect.width), y: (t.clientY - rect.top) * (this.height / rect.height) };
                };

                const down = (e) => {
                    if (this.isGameOver) return;
                    const pos = getPos(e);
                    if (this.bird.active && !this.bird.powerUsed) {
                        this.usePower();
                    } else if (!this.bird.active && Math.hypot(pos.x - this.bird.x, pos.y - this.bird.y) < 60) {
                        this.bird.dragging = true;
                    }
                };

                const move = (e) => {
                    if (this.bird.dragging) {
                        const pos = getPos(e);
                        const dx = pos.x - this.bird.anchorX;
                        const dy = pos.y - this.bird.anchorY;
                        const dist = Math.min(120, Math.hypot(dx, dy));
                        const angle = Math.atan2(dy, dx);
                        this.bird.x = this.bird.anchorX + Math.cos(angle) * dist;
                        this.bird.y = this.bird.anchorY + Math.sin(angle) * dist;
                    }
                };

                const up = () => {
                    if (this.bird.dragging) {
                        this.bird.dragging = false;
                        this.bird.active = true;
                        this.bird.vx = (this.bird.anchorX - this.bird.x) * 0.18;
                        this.bird.vy = (this.bird.anchorY - this.bird.y) * 0.18;
                        
                        const hint = document.getElementById('power-hint');
                        const type = BIRD_TYPES[this.bird.typeIndex];
                        if (type.power !== 'NONE') {
                            hint.textContent = type.powerText;
                            hint.style.opacity = 1;
                            setTimeout(() => hint.style.opacity = 0, 2000);
                        }
                    }
                };

                this.canvas.onmousedown = down;
                window.onmousemove = move;
                window.onmouseup = up;
                this.canvas.ontouchstart = (e) => { e.preventDefault(); down(e); };
                window.ontouchmove = move;
                window.ontouchend = up;
            }

            usePower() {
                const type = BIRD_TYPES[this.bird.typeIndex];
                if (type.power === 'DASH') {
                    this.bird.vx *= 2.5;
                    this.bird.vy *= 0.5;
                    this.bird.powerUsed = true;
                    this.spawnParticles(this.bird.x, this.bird.y, '#fff', 15);
                } else if (type.power === 'TRIPLE') {
                    const b1 = {...this.bird, vy: this.bird.vy - 3, powerUsed: true, id: Math.random()};
                    const b2 = {...this.bird, vy: this.bird.vy + 3, powerUsed: true, id: Math.random()};
                    this.bird.powerUsed = true;
                    // We'll just handle the main one, but visually triple would need an array of birds
                    // Simplified: just a huge impact for "Triple"
                    this.bird.r *= 1.5;
                    this.bird.powerUsed = true;
                }
                document.getElementById('power-hint').style.opacity = 0;
            }

            resetBird() {
                this.bird.active = false;
                this.bird.powerUsed = false;
                this.bird.x = this.bird.anchorX;
                this.bird.y = this.bird.anchorY;
                this.bird.vx = this.bird.vy = 0;
                this.bird.trail = [];
                this.bird.typeIndex = (this.bird.typeIndex + 1) % BIRD_TYPES.length;
                this.updateUI();
            }

            update() {
                this.clouds.forEach(c => { c.x += c.s; if(c.x > this.width + 200) c.x = -200; });

                if (this.bird.active) {
                    this.bird.vy += 0.25;
                    this.bird.x += this.bird.vx;
                    this.bird.y += this.bird.vy;
                    this.bird.trail.push({x: this.bird.x, y: this.bird.y, a: 1});
                    if (this.bird.trail.length > 15) this.bird.trail.shift();

                    this.objects.forEach((obj, i) => {
                        let hit = false;
                        if (obj.type === 'block') {
                            if (this.bird.x + this.bird.r > obj.x && this.bird.x - this.bird.r < obj.x + obj.w &&
                                this.bird.y + this.bird.r > obj.y && this.bird.y - this.bird.r < obj.y + obj.h) hit = true;
                        } else {
                            if (Math.hypot(this.bird.x - obj.x, this.bird.y - obj.y) < this.bird.r + obj.r) hit = true;
                        }

                        if (hit) {
                            this.spawnParticles(obj.x + (obj.w||0)/2, obj.y + (obj.h||0)/2, obj.type === 'enemy' ? '#4ade80' : '#8B4513', 10);
                            if (obj.type === 'enemy') {
                                this.score += 1000;
                                this.objects.splice(i, 1);
                            } else {
                                this.score += 100;
                                obj.hp -= 50;
                                if (obj.hp <= 0) this.objects.splice(i, 1);
                            }
                            this.bird.vx *= 0.5; this.bird.vy *= 0.5;
                            this.updateUI();
                        }
                    });

                    if (this.bird.x > this.width + 100 || this.bird.y > this.height - 20) this.resetBird();
                }

                this.particles.forEach((p, i) => {
                    p.x += p.vx; p.y += p.vy; p.vy += 0.2; p.l -= 0.02;
                    if (p.l <= 0) this.particles.splice(i, 1);
                });

                if (this.objects.filter(o => o.type === 'enemy').length === 0 && !this.isGameOver) {
                    this.victory();
                }
            }

            victory() {
                this.isGameOver = true;
                const overlay = document.getElementById('overlay');
                const title = document.getElementById('overlay-title');
                const btn = document.getElementById('action-btn');
                
                overlay.style.display = 'flex';
                if (this.level < 5) {
                    title.textContent = "LEVEL CLEAR";
                    btn.textContent = "NEXT LEVEL";
                } else {
                    title.textContent = "CHAMPION!";
                    btn.textContent = "PLAY AGAIN";
                }
            }

            handleAction() {
                if (this.level < 5) this.loadLevel(this.level + 1);
                else this.loadLevel(1);
            }

            spawnParticles(x, y, color, count) {
                for(let i=0; i<count; i++) this.particles.push({ x, y, vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10, l: 1, color });
            }

            updateUI() {
                document.getElementById('score-val').textContent = this.score;
                document.getElementById('pigs-val').textContent = this.objects.filter(o => o.type === 'enemy').length;
                const type = BIRD_TYPES[this.bird.typeIndex];
                document.getElementById('bird-type').textContent = `${type.emoji} ${type.name}`;
                document.getElementById('bird-type').style.color = type.color;
            }

            draw() {
                const ctx = this.ctx;
                ctx.clearRect(0, 0, this.width, this.height);

                this.clouds.forEach(c => {
                    ctx.fillStyle = 'rgba(255,255,255,0.3)';
                    ctx.beginPath(); ctx.ellipse(c.x, c.y, c.w, c.w*0.4, 0, 0, Math.PI*2); ctx.fill();
                });

                // Ground
                ctx.fillStyle = '#27ae60'; ctx.fillRect(0, this.height - 60, this.width, 60);

                // Slingshot
                ctx.strokeStyle = '#4e342e'; ctx.lineWidth = 10; ctx.lineCap = 'round';
                ctx.beginPath(); ctx.moveTo(this.bird.anchorX, this.height - 60); ctx.lineTo(this.bird.anchorX, this.bird.anchorY + 15); ctx.stroke();

                if (this.bird.dragging) {
                    ctx.strokeStyle = '#3e2723'; ctx.lineWidth = 4;
                    ctx.beginPath(); ctx.moveTo(this.bird.anchorX-10, this.bird.anchorY); ctx.lineTo(this.bird.x, this.bird.y); ctx.stroke();
                }

                // Bird
                const type = BIRD_TYPES[this.bird.typeIndex];
                ctx.save();
                ctx.translate(this.bird.x, this.bird.y);
                if (this.bird.active) ctx.rotate(Math.atan2(this.bird.vy, this.bird.vx));
                ctx.fillStyle = type.color;
                ctx.beginPath(); ctx.arc(0, 0, this.bird.r, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = 'white'; ctx.beginPath(); ctx.arc(10, -5, 6, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = 'black'; ctx.beginPath(); ctx.arc(12, -5, 2, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = '#ffa502'; ctx.beginPath(); ctx.moveTo(15, 0); ctx.lineTo(25, 5); ctx.lineTo(15, 10); ctx.fill();
                ctx.restore();

                if (this.bird.dragging) {
                    ctx.strokeStyle = '#3e2723'; ctx.lineWidth = 4;
                    ctx.beginPath(); ctx.moveTo(this.bird.anchorX+10, this.bird.anchorY); ctx.lineTo(this.bird.x, this.bird.y); ctx.stroke();
                }

                // Objects
                this.objects.forEach(obj => {
                    if (obj.type === 'block') {
                        ctx.fillStyle = '#8B4513';
                        ctx.fillRect(obj.x, obj.y, obj.w, obj.h);
                        ctx.strokeStyle = 'rgba(0,0,0,0.2)'; ctx.strokeRect(obj.x, obj.y, obj.w, obj.h);
                    } else {
                        ctx.fillStyle = '#44ff44';
                        ctx.beginPath(); ctx.arc(obj.x, obj.y, obj.r, 0, Math.PI*2); ctx.fill();
                        ctx.fillStyle = 'black'; ctx.beginPath(); ctx.arc(obj.x-6, obj.y-4, 2, 0, Math.PI*2); ctx.arc(obj.x+6, obj.y-4, 2, 0, Math.PI*2); ctx.fill();
                    }
                });

                this.particles.forEach(p => {
                    ctx.globalAlpha = p.l; ctx.fillStyle = p.color;
                    ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI*2); ctx.fill();
                });
                ctx.globalAlpha = 1;

                requestAnimationFrame(() => { this.update(); this.draw(); });
            }

            loop() {
                // Main loop is called via requestAnimationFrame in draw
            }
        }

        const game = new BirdSling();
    </script>
</body>
</html>
