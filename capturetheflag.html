<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capture the Flag: 5v5 Edition</title>
    <style>
        body { margin: 0; background: #2d5a27; color: white; font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; overflow: hidden; }
        canvas { background: #4CAF50; border: 5px solid #fff; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); cursor: crosshair; }
        #ui { position: absolute; top: 20px; display: flex; gap: 40px; background: rgba(0,0,0,0.7); padding: 10px 30px; border-radius: 30px; backdrop-filter: blur(5px); pointer-events: none; border: 2px solid rgba(255,255,255,0.2); }
        .score-box { text-align: center; font-weight: 900; }
        .blue { color: #3b82f6; }
        .red { color: #ef4444; }
        .controls { position: absolute; bottom: 20px; right: 20px; font-size: 0.8rem; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 8px; text-align: right; }
        .back { position: absolute; bottom: 20px; left: 20px; color: white; text-decoration: none; background: #3b82f6; padding: 10px 20px; border-radius: 8px; font-weight: bold; }
    </style>
</head>
<body>
    <div id="ui">
        <div class="score-box blue">BLUE: <span id="blueScore">0</span> | <small>JAIL: <span id="blueJailCount">0</span></small></div>
        <div class="score-box red">RED: <span id="redScore">0</span> | <small>JAIL: <span id="redJailCount">0</span></small></div>
    </div>

    <canvas id="game"></canvas>

    <div class="controls">
        <b>YOU ARE BLUE (Circle with White Outline)</b><br>
        WASD/Arrows to Move • Space to Dash<br>
        Capture Red Flag (Right) • Touch your Jail to Free Friends
    </div>
    <a href="index.html" class="back">← HUB</a>

    <script>
        const canvas = document.getElementById('game');
        const ctx = canvas.getContext('2d');
        canvas.width = 1000; canvas.height = 600;

        // Constants
        const TEAM_SIZE = 5;
        const MID = canvas.width / 2;
        const SPEED = 3.5;
        const BOT_SPEED = 3.2;

        let scores = { blue: 0, red: 0 };
        let keys = {};
        
        // Entities
        let player;
        let blueTeam = [];
        let redTeam = [];
        let redFlag = { x: 920, y: 300, team: 'red', holder: null, homeX: 920, homeY: 300 };
        let blueFlag = { x: 80, y: 300, team: 'blue', holder: null, homeX: 80, homeY: 300 };
        let redJail = { x: 900, y: 50, w: 80, h: 80 }; // Where Blue team goes
        let blueJail = { x: 20, y: 50, w: 80, h: 80 }; // Where Red team goes

        function init() {
            // Setup Player
            player = { x: 150, y: 300, r: 14, team: 'blue', isPlayer: true, inJail: false, hasFlag: false, dash: 0 };
            blueTeam = [player];
            
            // Add Blue AI
            for(let i=1; i<TEAM_SIZE; i++) {
                blueTeam.push({
                    x: 100, y: 100 + i*100, r: 12, team: 'blue', 
                    role: i < 3 ? 'attacker' : 'defender',
                    inJail: false, hasFlag: false, vx: 0, vy: 0
                });
            }

            // Add Red AI
            for(let i=0; i<TEAM_SIZE; i++) {
                redTeam.push({
                    x: 900, y: 100 + i*100, r: 12, team: 'red',
                    role: i < 2 ? 'attacker' : 'defender',
                    inJail: false, hasFlag: false, vx: 0, vy: 0
                });
            }
            
            loop();
        }

        function updateBot(bot, teammates, opponents, myFlag, enemyFlag, myJail, enemyJail) {
            if (bot.inJail) return;

            let target = null;
            const side = bot.team === 'blue' ? 1 : -1;
            const homeSide = bot.team === 'blue' ? (bot.x < MID) : (bot.x > MID);

            if (bot.hasFlag) {
                // Return flag to base
                target = { x: bot.team === 'blue' ? 50 : 950, y: 300 };
            } else if (teammates.some(t => t.inJail)) {
                // Go to enemy jail to rescue
                target = { x: enemyJail.x + enemyJail.w/2, y: enemyJail.y + enemyJail.h/2 };
            } else if (bot.role === 'attacker') {
                // Go for flag
                target = enemyFlag;
            } else {
                // Defender: Guard base or chase enemies on our side
                const intruder = opponents.find(o => !o.inJail && (bot.team === 'blue' ? o.x < MID : o.x > MID));
                if (intruder) target = intruder;
                else target = { x: bot.team === 'blue' ? 200 : 800, y: bot.y }; // Idle patrol
            }

            if (target) {
                let ang = Math.atan2(target.y - bot.y, target.x - bot.x);
                bot.x += Math.cos(ang) * BOT_SPEED;
                bot.y += Math.sin(ang) * BOT_SPEED;
            }

            // Keep in bounds
            bot.x = Math.max(bot.r, Math.min(canvas.width - bot.r, bot.x));
            bot.y = Math.max(bot.r, Math.min(canvas.height - bot.r, bot.y));
        }

        function update() {
            // 1. Player Move
            if (!player.inJail) {
                let speed = keys['Space'] && player.dash > 0 ? SPEED * 2 : SPEED;
                if (keys['ArrowUp'] || keys['KeyW']) player.y -= speed;
                if (keys['ArrowDown'] || keys['KeyS']) player.y += speed;
                if (keys['ArrowLeft'] || keys['KeyA']) player.x -= speed;
                if (keys['ArrowRight'] || keys['KeyD']) player.x += speed;
            }

            // 2. Bots Logic
            blueTeam.slice(1).forEach(b => updateBot(b, blueTeam, redTeam, blueFlag, redFlag, blueJail, redJail));
            redTeam.forEach(b => updateBot(b, redTeam, blueTeam, redFlag, blueFlag, redJail, blueJail));

            // 3. Interactions (Flag / Tag / Jail)
            const allBlue = blueTeam;
            const allRed = redTeam;

            // Flags
            [redFlag, blueFlag].forEach(f => {
                const team = f.team === 'red' ? allBlue : allRed;
                const opponents = f.team === 'red' ? allRed : allBlue;
                
                if (!f.holder) {
                    team.forEach(p => {
                        if (!p.inJail && Math.hypot(p.x - f.x, p.y - f.y) < 30) {
                            f.holder = p; p.hasFlag = true;
                        }
                    });
                } else {
                    f.x = f.holder.x; f.y = f.holder.y;
                    // Score check
                    const homeLine = f.team === 'red' ? (f.x < MID) : (f.x > MID);
                    if (homeLine) {
                        scores[f.holder.team]++;
                        f.holder.hasFlag = false;
                        f.holder = null;
                        f.x = f.homeX; f.y = f.homeY;
                        alert(`${f.team.toUpperCase()} FLAG CAPTURED!`);
                    }
                }
            });

            // Tagging
            allBlue.forEach(b => {
                if (b.inJail) return;
                allRed.forEach(r => {
                    if (r.inJail) return;
                    if (Math.hypot(b.x - r.x, b.y - r.y) < 25) {
                        // Tag!
                        if (b.x > MID && r.x > MID) { // Blue tagged on Red side
                            b.inJail = true; b.x = redJail.x + 20 + Math.random()*40; b.y = redJail.y + 20 + Math.random()*40;
                            if(b.hasFlag) { redFlag.holder = null; redFlag.x = redFlag.homeX; redFlag.y = redFlag.homeY; b.hasFlag = false; }
                        } else if (r.x < MID && b.x < MID) { // Red tagged on Blue side
                            r.inJail = true; r.x = blueJail.x + 20 + Math.random()*40; r.y = blueJail.y + 20 + Math.random()*40;
                            if(r.hasFlag) { blueFlag.holder = null; blueFlag.x = blueFlag.homeX; blueFlag.y = blueFlag.homeY; r.hasFlag = false; }
                        }
                    }
                });
            });

            // Jailbreak
            allBlue.forEach(b => {
                if (!b.inJail && b.x > redJail.x && b.x < redJail.x + redJail.w && b.y > redJail.y && b.y < redJail.y + redJail.h) {
                    allBlue.forEach(t => { if(t.inJail) { t.inJail = false; t.x = MID - 50; }});
                }
            });
            allRed.forEach(r => {
                if (!r.inJail && r.x > blueJail.x && r.x < blueJail.x + blueJail.w && r.y > blueJail.y && r.y < blueJail.y + blueJail.h) {
                    allRed.forEach(t => { if(t.inJail) { t.inJail = false; t.x = MID + 50; }});
                }
            });

            document.getElementById('blueScore').textContent = scores.blue;
            document.getElementById('redScore').textContent = scores.red;
            document.getElementById('blueJailCount').textContent = allBlue.filter(b => b.inJail).length;
            document.getElementById('redJailCount').textContent = allRed.filter(r => r.inJail).length;
        }

        function loop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Field
            ctx.fillStyle = 'rgba(59, 130, 246, 0.15)'; ctx.fillRect(0, 0, MID, canvas.height);
            ctx.fillStyle = 'rgba(239, 68, 68, 0.15)'; ctx.fillRect(MID, 0, MID, canvas.height);
            ctx.strokeStyle = 'white'; ctx.lineWidth = 2; ctx.setLineDash([10, 5]);
            ctx.beginPath(); ctx.moveTo(MID, 0); ctx.lineTo(MID, canvas.height); ctx.stroke();
            ctx.setLineDash([]);

            // Jails
            ctx.strokeStyle = '#ef4444'; ctx.strokeRect(redJail.x, redJail.y, redJail.w, redJail.h);
            ctx.strokeStyle = '#3b82f6'; ctx.strokeRect(blueJail.x, blueJail.y, blueJail.w, blueJail.h);

            // Flags
            [blueFlag, redFlag].forEach(f => {
                ctx.fillStyle = f.team === 'blue' ? '#3b82f6' : '#ef4444';
                ctx.beginPath(); ctx.moveTo(f.x, f.y); ctx.lineTo(f.x+25, f.y-15); ctx.lineTo(f.x, f.y-30); ctx.fill();
                ctx.strokeStyle = 'white'; ctx.beginPath(); ctx.moveTo(f.x, f.y); ctx.lineTo(f.x, f.y-40); ctx.stroke();
            });

            // Teams
            const drawUnit = (u) => {
                ctx.fillStyle = u.team === 'blue' ? '#3b82f6' : '#ef4444';
                ctx.beginPath(); ctx.arc(u.x, u.y, u.r, 0, Math.PI*2); ctx.fill();
                ctx.strokeStyle = u.isPlayer ? 'white' : 'rgba(0,0,0,0.3)';
                ctx.lineWidth = u.isPlayer ? 3 : 1;
                ctx.stroke();
                if (u.hasFlag) { ctx.fillStyle = 'gold'; ctx.beginPath(); ctx.arc(u.x, u.y-20, 6, 0, Math.PI*2); ctx.fill(); }
                if (u.inJail) { ctx.fillStyle = 'white'; ctx.font = '10px Arial'; ctx.textAlign='center'; ctx.fillText("JAIL", u.x, u.y+4); }
            };

            blueTeam.forEach(drawUnit);
            redTeam.forEach(drawUnit);

            update();
            requestAnimationFrame(loop);
        }

        window.onkeydown = e => keys[e.code] = true;
        window.onkeyup = e => keys[e.code] = false;

        init();
    </script>
</body>
</html>