<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donkey Smash: Master Edition - K4 Games</title>
    <style>
        :root {
            --bg: #0f172a;
            --girder: #ef4444;
            --ladder: #38bdf8;
            --accent: #f59e0b;
            --text: #f8fafc;
            --panel: rgba(30, 41, 59, 0.9);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }
        
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Segoe UI', system-ui, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        #game-container {
            position: relative;
            background: #000;
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.8);
            border: 8px solid #334155;
            overflow: hidden;
        }

        canvas { display: block; image-rendering: pixelated; }

        /* UI Overlay */
        #ui-layer {
            position: absolute;
            inset: 0;
            pointer-events: none;
            padding: 25px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            z-index: 100;
        }

        .hud-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .stat-card {
            background: var(--panel);
            backdrop-filter: blur(12px);
            padding: 12px 25px;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.1);
            text-align: center;
            min-width: 150px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.3);
        }

        .stat-val { font-size: 1.8rem; font-weight: 900; color: var(--accent); font-family: 'JetBrains Mono', monospace; }
        .stat-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; opacity: 0.6; }

        .back-link {
            position: fixed; top: 20px; left: 20px; color: white; text-decoration: none;
            background: rgba(255,255,255,0.1); padding: 12px 24px; border-radius: 12px; z-index: 1000;
            font-weight: bold; backdrop-filter: blur(10px); transition: 0.2s; border: 1px solid rgba(255,255,255,0.1);
        }
        .back-link:hover { background: rgba(255,255,255,0.2); transform: translateY(-2px); }

        /* Modals */
        .modal {
            position: absolute; inset: 0;
            background: rgba(15, 23, 42, 0.95);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 2000; backdrop-filter: blur(15px); text-align: center;
        }

        h1 { font-size: 4.5rem; color: var(--accent); font-style: italic; font-weight: 900; margin-bottom: 30px; letter-spacing: -2px; }
        
        .difficulty-grid { display: flex; gap: 20px; margin-top: 20px; }
        
        .btn {
            background: var(--accent); color: #000; border: none; padding: 15px 40px;
            border-radius: 50px; font-weight: 800; cursor: pointer; font-size: 1.2rem;
            transition: 0.2s; box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        .btn:hover { transform: scale(1.05); filter: brightness(1.1); }
        .btn-diff { background: #334155; color: white; min-width: 140px; border: 1px solid rgba(255,255,255,0.1); }
        .btn-diff:hover { background: var(--girder); border-color: white; }

        .controls-hint {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: var(--panel); padding: 10px 30px; border-radius: 50px;
            font-size: 0.85rem; opacity: 0.9; color: white; border: 1px solid rgba(255,255,255,0.1);
            white-space: nowrap;
        }

        #hammer-alert {
            position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: #ef4444; color: white; padding: 8px 20px; border-radius: 8px;
            font-weight: 900; display: none; animation: flash 0.5s infinite;
        }
        @keyframes flash { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>
    <a href="index.html" class="back-link">‚Üê HUB</a>

    <div id="game-container">
        <canvas id="gameCanvas" width="640" height="800"></canvas>
        
        <div id="ui-layer">
            <div class="hud-top">
                <div class="stat-card">
                    <div id="score-val" class="stat-val">000000</div>
                    <div class="stat-label">Score</div>
                </div>
                <div class="stat-card">
                    <div id="lives-val" class="stat-val">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
                    <div class="stat-label">Lives</div>
                </div>
                <div class="stat-card">
                    <div id="bonus-val" class="stat-val">5000</div>
                    <div class="stat-label">Bonus</div>
                </div>
            </div>
        </div>

        <div id="hammer-alert">üî® HAMMER ACTIVE! (PRESS H)</div>

        <!-- Start Modal -->
        <div id="start-modal" class="modal">
            <h1>DONKEY SMASH</h1>
            <p style="font-size: 1.2rem; opacity: 0.7; max-width: 400px; line-height: 1.6;">Climb the girders, dodge the barrels, and rescue the Princess from the clutches of the Great Gorilla!</p>
            <div class="difficulty-grid">
                <button class="btn btn-diff" onclick="game.start('easy')">EASY</button>
                <button class="btn btn-diff" onclick="game.start('medium')">MEDIUM</button>
                <button class="btn btn-diff" onclick="game.start('hard')">HARD</button>
            </div>
            <div style="margin-top: 40px; font-size: 0.9rem; opacity: 0.5;">HIGH SCORE: <span id="hi-score-val">000000</span></div>
        </div>

        <!-- Game Over Modal -->
        <div id="over-modal" class="modal" style="display: none;">
            <h1 id="over-title" style="color: var(--girder);">GAME OVER</h1>
            <p id="final-score" style="font-size: 2rem; font-weight: 800; margin-bottom: 10px;"></p>
            <p id="new-hi-txt" style="color: var(--accent); font-weight: 900; margin-bottom: 30px; display: none;">NEW HIGH SCORE!</p>
            <button class="btn" onclick="location.reload()">TRY AGAIN</button>
        </div>

        <div class="controls-hint">
            <b>ARROWS</b>: Move/Climb ‚Ä¢ <b>SPACE</b>: Jump ‚Ä¢ <b>H</b>: Smash (with Hammer)
        </div>
    </div>

    <script>
        const GRAVITY = 0.45;
        const JUMP = -9.0;
        const SPEED = 3.8;

        class DonkeySmash {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.width = 640;
                this.height = 800;

                this.player = { 
                    x: 50, y: 720, w: 32, h: 40, 
                    vx: 0, vy: 0, 
                    dir: 1, anim: 0, 
                    onGround: false, climbing: false, 
                    hammer: 0, hammerTimer: 0,
                    invuln: 0
                };

                this.platforms = [];
                this.ladders = [];
                this.barrels = [];
                this.hammers = [];
                this.fireballs = [];
                this.particles = [];
                
                this.score = 0;
                this.bonus = 5000;
                this.lives = 3;
                this.frame = 0;
                this.gameActive = false;
                this.difficulty = 'medium';
                this.barrelInterval = 120;
                this.highScore = parseInt(localStorage.getItem('k4-donkeysmash-hi') || 0);

                this.kong = { state: 'idle', timer: 0 };
                this.oilDrum = { x: 40, y: 720, anim: 0 };

                this.keys = {};
                this.initLevel();
                this.setupInputs();
                document.getElementById('hi-score-val').textContent = this.highScore.toString().padStart(6, '0');
            }

            initLevel() {
                // Zig-Zag Arcade Layout
                this.platforms = [
                    { x: 0, y: 760, w: 640, s: 0, type: 'girder' },    // Ground
                    { x: 0, y: 660, w: 580, s: -20, type: 'girder' },  // L1 rolls Left
                    { x: 60, y: 560, w: 580, s: 20, type: 'girder' },  // L2 rolls Right
                    { x: 0, y: 460, w: 580, s: -20, type: 'girder' },  // L3 rolls Left
                    { x: 60, y: 360, w: 580, s: 20, type: 'girder' },  // L4 rolls Right
                    { x: 0, y: 260, w: 580, s: -20, type: 'girder' },  // L5 rolls Left
                    { x: 100, y: 160, w: 200, s: 0, type: 'girder' },  // Kong
                    { x: 300, y: 100, w: 100, s: 0, type: 'girder' }   // Princess
                ];

                this.ladders = [
                    { x: 530, y: 640, h: 120 },
                    { x: 80, y: 580, h: 100 },
                    { x: 530, y: 440, h: 120 },
                    { x: 80, y: 380, h: 100 },
                    { x: 530, y: 240, h: 120 },
                    { x: 250, y: 160, h: 100 },
                    { x: 340, y: 100, h: 60 }
                ];

                this.hammers = [
                    { x: 100, y: 430, active: true },
                    { x: 520, y: 630, active: true }
                ];
            }

            setupInputs() {
                window.onkeydown = (e) => {
                    this.keys[e.code] = true;
                    if (e.code === 'KeyH' && this.player.hammer > 0) this.hammerSmash();
                };
                window.onkeyup = (e) => this.keys[e.code] = false;
            }

            start(diff) {
                this.difficulty = diff;
                this.barrelInterval = diff === 'easy' ? 180 : diff === 'medium' ? 120 : 80;
                this.gameActive = true;
                document.getElementById('start-modal').style.display = 'none';
                this.draw();
            }

            getPlatformY(x, p) {
                let relativeX = (x - p.x) / p.w;
                return p.y + (relativeX * p.s);
            }

            spawnBarrel() {
                this.kong.state = 'throwing';
                this.kong.timer = 20;
                this.barrels.push({ 
                    x: 150, y: 120, r: 14, 
                    vx: 3.5, vy: 0, 
                    angle: 0,
                    jumped: false
                });
            }

            spawnFireball() {
                if (Math.random() < (this.difficulty === 'hard' ? 0.02 : 0.005)) {
                    this.fireballs.push({ 
                        x: this.oilDrum.x + 20, y: this.oilDrum.y, 
                        vx: (Math.random()-0.5)*4, vy: -5, 
                        r: 12, anim: 0 
                    });
                }
            }

            update() {
                if (!this.gameActive) return;
                this.frame++;

                if (this.frame % this.barrelInterval === 0) this.spawnBarrel();
                if (this.frame % 60 === 0 && this.bonus > 0) this.bonus -= 100;
                this.spawnFireball();

                if (this.kong.timer > 0) this.kong.timer--;
                else this.kong.state = 'idle';

                const p = this.player;

                // --- PLAYER ---
                if (!p.climbing) {
                    if (this.keys['ArrowLeft'] || this.keys['KeyA']) { p.vx = -SPEED; p.dir = -1; }
                    else if (this.keys['ArrowRight'] || this.keys['KeyD']) { p.vx = SPEED; p.dir = 1; }
                    else { p.vx *= 0.8; }
                    p.vy += GRAVITY;
                    p.x += p.vx;
                    p.y += p.vy;
                } else {
                    p.x += p.vx * 0.3;
                    p.y += p.vy;
                }

                // Ladder
                let nearLadder = null;
                this.ladders.forEach(l => {
                    if (Math.abs(p.x + p.w/2 - (l.x + 12)) < 25 && p.y + p.h > l.y && p.y < l.y + l.h) {
                        nearLadder = l;
                    }
                });

                if (nearLadder) {
                    if (this.keys['ArrowUp'] || this.keys['KeyW']) { p.climbing = true; p.vy = -3.5; p.vx = 0; }
                    else if (this.keys['ArrowDown'] || this.keys['KeyS']) { p.climbing = true; p.vy = 3.5; p.vx = 0; }
                    else if (p.climbing) { p.vy = 0; }
                } else {
                    p.climbing = false;
                }

                // Platform Collision
                p.onGround = false;
                if (!p.climbing) {
                    this.platforms.forEach(plat => {
                        if (p.x + p.w/2 > plat.x && p.x + p.w/2 < plat.x + plat.w) {
                            let py = this.getPlatformY(p.x + p.w/2, plat);
                            if (p.y + p.h >= py && p.y + p.h <= py + 20 && p.vy >= 0) {
                                p.y = py - p.h; p.vy = 0; p.onGround = true;
                            }
                        }
                    });
                }

                if ((this.keys['Space'] || this.keys['ArrowUp']) && p.onGround && !p.climbing) {
                    p.vy = JUMP; p.onGround = false;
                }

                // --- BARRELS ---
                for (let i = this.barrels.length - 1; i >= 0; i--) {
                    const b = this.barrels[i];
                    b.vy += GRAVITY;
                    b.x += b.vx;
                    b.y += b.vy;
                    b.angle += b.vx * 0.06;

                    let onP = false;
                    this.platforms.forEach(plat => {
                        if (b.x > plat.x && b.x < plat.x + plat.w) {
                            let py = this.getPlatformY(b.x, plat);
                            if (b.y + b.r >= py && b.y + b.r <= py + 20) {
                                b.y = py - b.r; b.vy = 0; onP = true;
                                if (plat.s !== 0) b.vx = plat.s > 0 ? -3.8 : 3.8;
                            }
                        }
                    });

                    // Scoring: Jump over barrel
                    if (!b.jumped && !p.climbing && p.y + p.h < b.y && Math.abs(p.x + p.w/2 - b.x) < 20) {
                        b.jumped = true;
                        this.score += 100;
                        this.spawnParticles(b.x, b.y - 20, '#fff');
                    }

                    if (Math.hypot(p.x + p.w/2 - b.x, p.y + p.h/2 - b.y) < 30) {
                        if (p.hammer > 0) this.destroyBarrel(b, i);
                        else if (p.invuln <= 0) this.die();
                    }
                }

                // --- FIREBALLS ---
                for (let i = this.fireballs.length - 1; i >= 0; i--) {
                    const f = this.fireballs[i];
                    f.vy += GRAVITY * 0.5;
                    f.x += f.vx;
                    f.y += f.vy;
                    f.anim += 0.1;

                    this.platforms.forEach(plat => {
                        if (f.x > plat.x && f.x < plat.x + plat.w) {
                            let py = this.getPlatformY(f.x, plat);
                            if (f.y + f.r >= py && f.y + f.r <= py + 20) {
                                f.y = py - f.r; f.vy = -Math.random()*5;
                                if (Math.random() < 0.05) f.vx *= -1;
                            }
                        }
                    });

                    if (Math.hypot(p.x + p.w/2 - f.x, p.y + p.h/2 - f.y) < 30) {
                        if (p.hammer > 0) {
                            this.fireballs.splice(i, 1); this.score += 800;
                            this.spawnParticles(f.x, f.y, '#f59e0b');
                        } else if (p.invuln <= 0) this.die();
                    }
                }

                // Powerups
                if (p.hammer > 0) {
                    p.hammer--;
                    document.getElementById('hammer-alert').style.display = 'block';
                    if (p.hammer <= 0) document.getElementById('hammer-alert').style.display = 'none';
                }
                this.hammers.forEach(h => {
                    if (h.active && Math.hypot(p.x - h.x, p.y - h.y) < 45) {
                        h.active = false; p.hammer = 600; this.score += 100;
                    }
                });

                // Win
                if (p.y < 100 && p.x > 300 && p.x < 400) this.win();

                if (p.x < 0) p.x = 0;
                if (p.x > this.width - p.w) p.x = this.width - p.w;
                if (p.y > this.height) this.die();

                if (Math.abs(p.vx) > 0.1 || p.climbing) p.anim += 0.2;
                if (p.invuln > 0) p.invuln--;

                for (let i = this.particles.length - 1; i >= 0; i--) {
                    const part = this.particles[i];
                    part.x += part.vx; part.y += part.vy; part.life -= 0.02;
                    if (part.life <= 0) this.particles.splice(i, 1);
                }

                this.updateUI();
            }

            hammerSmash() {
                for (let i = this.barrels.length - 1; i >= 0; i--) {
                    const b = this.barrels[i];
                    if (Math.hypot(this.player.x - b.x, this.player.y - b.y) < 100) this.destroyBarrel(b, i);
                }
            }

            destroyBarrel(b, i) {
                this.spawnParticles(b.x, b.y, '#92400e');
                this.barrels.splice(i, 1);
                this.score += 500;
            }

            spawnParticles(x, y, color) {
                for(let i=0; i<12; i++) {
                    this.particles.push({
                        x, y, vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10, life: 1.0, color
                    });
                }
            }

            die() {
                this.lives--;
                this.spawnParticles(this.player.x, this.player.y, '#ef4444');
                if (this.lives <= 0) this.endGame("GAME OVER");
                else {
                    this.player.x = 50; this.player.y = 720;
                    this.player.vx = 0; this.player.vy = 0;
                    this.player.invuln = 120;
                    this.barrels = [];
                }
            }

            win() {
                this.score += this.bonus;
                this.endGame("VICTORY!");
            }

            endGame(msg) {
                this.gameActive = false;
                document.getElementById('over-modal').style.display = 'flex';
                document.getElementById('over-title').textContent = msg;
                document.getElementById('over-title').style.color = msg === "VICTORY!" ? "var(--accent)" : "var(--girder)";
                document.getElementById('final-score').textContent = `FINAL SCORE: ${this.score.toString().padStart(6, '0')}`;
                if (this.score > this.highScore) {
                    this.highScore = this.score;
                    localStorage.setItem('k4-donkeysmash-hi', this.highScore);
                    document.getElementById('new-hi-txt').style.display = 'block';
                }
            }

            updateUI() {
                document.getElementById('score-val').textContent = this.score.toString().padStart(6, '0');
                document.getElementById('bonus-val').textContent = Math.max(0, this.bonus);
                document.getElementById('lives-val').textContent = "‚ù§Ô∏è".repeat(this.lives);
            }

            draw() {
                const ctx = this.ctx;
                ctx.clearRect(0, 0, this.width, this.height);

                // --- Girders ---
                ctx.strokeStyle = '#ef4444';
                ctx.lineWidth = 6;
                this.platforms.forEach(p => {
                    ctx.beginPath();
                    ctx.moveTo(p.x, p.y);
                    ctx.lineTo(p.x + p.w, p.y + p.s);
                    ctx.stroke();
                    for(let i=0; i<p.w; i+=25) {
                        const x = p.x + i;
                        const y = this.getPlatformY(x, p);
                        ctx.beginPath(); ctx.moveTo(x, y); ctx.lineTo(x, y + 12); ctx.stroke();
                        ctx.lineWidth = 2;
                        ctx.beginPath(); ctx.moveTo(x, y); ctx.lineTo(x + 25, y + 12 + (p.s/p.w)*25); ctx.stroke();
                        ctx.lineWidth = 6;
                    }
                });

                // --- Ladders ---
                ctx.strokeStyle = '#38bdf8';
                this.ladders.forEach(l => {
                    ctx.lineWidth = 5;
                    ctx.beginPath();
                    ctx.moveTo(l.x, l.y); ctx.lineTo(l.x, l.y + l.h);
                    ctx.moveTo(l.x + 24, l.y); ctx.lineTo(l.x + 24, l.y + l.h);
                    ctx.stroke();
                    ctx.lineWidth = 3;
                    for(let y=l.y + 10; y<l.y+l.h; y+=15) {
                        ctx.beginPath(); ctx.moveTo(l.x, y); ctx.lineTo(l.x+24, y); ctx.stroke();
                    }
                });

                // Oil Drum
                ctx.fillStyle = '#1e293b';
                ctx.fillRect(this.oilDrum.x, this.oilDrum.y, 40, 40);
                ctx.fillStyle = '#ef4444';
                ctx.font = '20px Arial';
                ctx.fillText('üî•', this.oilDrum.x + 5, this.oilDrum.y + 25);

                // --- Entities ---
                // Gorilla
                ctx.save();
                const kongY = 155 + Math.sin(this.frame/15)*8;
                ctx.font = '100px Arial';
                if (this.kong.state === 'throwing') {
                    ctx.translate(140, kongY);
                    ctx.scale(-1, 1);
                    ctx.fillText('ü¶ç', 0, 0);
                } else {
                    ctx.fillText('ü¶ç', 140, kongY);
                }
                ctx.restore();

                // Princess
                ctx.font = '50px Arial';
                ctx.fillText('üë∏', 330, 95 + Math.sin(this.frame/20)*5);

                // Hammers
                this.hammers.forEach(h => {
                    if (!h.active) return;
                    ctx.save();
                    ctx.translate(h.x, h.y);
                    ctx.rotate(Math.sin(this.frame/10)*0.3);
                    ctx.font = '45px Arial';
                    ctx.fillText('üî®', -22, 22);
                    ctx.restore();
                });

                // Barrels
                this.barrels.forEach(b => {
                    ctx.save();
                    ctx.translate(b.x, b.y);
                    ctx.rotate(b.angle);
                    ctx.fillStyle = '#92400e';
                    ctx.beginPath(); ctx.arc(0, 0, b.r, 0, Math.PI*2); ctx.fill();
                    ctx.strokeStyle = '#451a03'; ctx.lineWidth = 4; ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(-b.r, -b.r/3); ctx.lineTo(b.r, -b.r/3); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(-b.r, b.r/3); ctx.lineTo(b.r, b.r/3); ctx.stroke();
                    ctx.restore();
                });

                // Fireballs
                this.fireballs.forEach(f => {
                    ctx.save();
                    ctx.translate(f.x, f.y);
                    const scale = 1 + Math.sin(f.anim)*0.2;
                    ctx.scale(scale, scale);
                    ctx.font = '35px Arial';
                    ctx.fillText('üî•', -17, 17);
                    ctx.restore();
                });

                // Particles
                this.particles.forEach(part => {
                    ctx.globalAlpha = part.life; ctx.fillStyle = part.color;
                    ctx.beginPath(); ctx.arc(part.x, part.y, 4, 0, Math.PI*2); ctx.fill();
                });
                ctx.globalAlpha = 1.0;

                // Player
                const p = this.player;
                ctx.save();
                ctx.translate(p.x + p.w/2, p.y + p.h/2);
                if (p.dir === -1) ctx.scale(-1, 1);
                
                const waddle = (p.onGround || p.climbing) ? Math.sin(p.anim) * 6 : 0;
                
                // Jumpman Sprite
                ctx.fillStyle = '#ef4444'; // Shirt/Hat
                ctx.fillRect(-12, -25 + waddle, 24, 25);
                ctx.fillStyle = '#3b82f6'; // Overalls
                ctx.fillRect(-12, -10 + waddle, 24, 20);
                ctx.fillStyle = '#fecaca'; // Skin
                ctx.fillRect(0, -22 + waddle, 12, 12);
                ctx.fillStyle = '#000'; // Eyes
                ctx.fillRect(8, -18 + waddle, 3, 3);
                
                if (p.hammer > 0) {
                    ctx.shadowBlur = 25; ctx.shadowColor = this.frame % 10 < 5 ? '#fff' : '#f00';
                    ctx.save();
                    ctx.translate(20, -20 + waddle);
                    ctx.rotate(Math.sin(this.frame/5)*0.5);
                    ctx.font = '40px Arial';
                    ctx.fillText('üî®', 0, 0);
                    ctx.restore();
                }
                
                if (p.invuln % 10 > 5) ctx.globalAlpha = 0.3;
                ctx.restore();

                this.update();
                requestAnimationFrame(() => this.draw());
            }
        }

        const game = new DonkeySmash();
    </script>
</body>
</html>